<!DOCTYPE html>
<html lang="en">

<head>
  <meta charset="utf-8" />
  <title>Log</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
</head>

<body>
  <div id="root" />
  <script type="module" src="/src/index.tsx"></script>
  <script>
    const displayedFiles = [];
    const texts = [];
    let isPolling = false;

    async function pollFileIndex() {
      if (isPolling) return; // Prevent overlapping polling intervals
      isPolling = true;

      try {
        const cacheBusting = new Date().getTime();
        const filesResult = await fetch(`/fileindex.txt?_=${cacheBusting}`);
        const files = (await filesResult.text()).split("\n").filter(Boolean); // Filter out empty lines

        for (const filename of files) {
          if (!displayedFiles.includes(filename)) {
            try {
              const fileResult = await fetch(filename);
              const fileText = await fileResult.text();

              const index = files.indexOf(filename);
              displayedFiles.splice(index, 0, filename);
              texts.splice(index, 0, fileText);
            } catch (err) {
              console.error(`Failed to fetch file ${filename}:`, err);
              // Optionally, inform the user or take other actions
            }
          }
        }

        window.setContents({
          initialContents: texts.join("\n")
        });
      } catch (err) {
        console.error('Failed to fetch fileindex.txt:', err);
        // Optionally, inform the user or take other actions
      } finally {
        isPolling = false; // Reset the polling flag when done
      }
    }

    window.addEventListener('load', async () => {
      setInterval(() => {
        pollFileIndex();
      }, 5000);
    });
  </script>
</body>

</html>